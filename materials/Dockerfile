# =============================================================================
#
# ============================================================================= 

FROM golang:1.13-alpine
MAINTAINER Keshav <keshavt@umbrellainfocare.com> 

# ----------------------------------------------------------------------------
# Create new user and group
# ----------------------------------------------------------------------------

RUN adduser -D -g 'alpine' alpine

# ----------------------------------------------------------------------------
# Install 
# ----------------------------------------------------------------------------
  
# ----------------------------------------------------------------------------- 
# Copy content 
# ----------------------------------------------------------------------------- 

RUN mkdir /opt/api/
COPY . /opt/api/
COPY buildScripts/startup.sh /opt/api/

# ----------------------------------------------------------------------------- 
# Change owner and permission 
# ----------------------------------------------------------------------------- 

RUN chown -R alpine:alpine /opt/api/
RUN chmod +x /opt/api/startup.sh
 
# ----------------------------------------------------------------------------- 
# Switch user
# ----------------------------------------------------------------------------- 

USER alpine
WORKDIR /opt/api/

# ----------------------------------------------------------------------------- 
# Install libraries 
# ----------------------------------------------------------------------------- 

RUN go mod download

# ----------------------------------------------------------------------------- 
# Create build 
# ----------------------------------------------------------------------------- 

RUN go build -o ./out/imaterial .

# ----------------------------------------------------------------------------- 
# Remove extra files 
# ----------------------------------------------------------------------------- 

RUN rm -rf buildScripts/ Jenkinsfile Dockerfile .git/ README.md

# ----------------------------------------------------------------------------- 
# Set ports 
# ----------------------------------------------------------------------------- 

EXPOSE 8080

CMD /opt/api/startup.sh

#ENTRYPOINT ["tail", "-f", "/dev/null"]

